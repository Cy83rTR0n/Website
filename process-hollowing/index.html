<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Process Hollowing Demistyfied</title>
<meta name=description content="ret2libc"><meta name=keywords content="blog,gokarna,hugo,Malware"><meta property="og:url" content="https://Cy83rTR0n.github.io/website/process-hollowing/"><meta property="og:type" content="website"><meta property="og:title" content="Process Hollowing Demistyfied"><meta property="og:description" content="ret2libc"><meta property="og:image" content="https://images.unsplash.com/photo-1544890225-2f3faec4cd60?auto=format&amp;fit=crop&amp;q=60&amp;w=500&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGFja2VyfGVufDB8fDB8fHww"><meta property="og:image:secure_url" content="https://images.unsplash.com/photo-1544890225-2f3faec4cd60?auto=format&amp;fit=crop&amp;q=60&amp;w=500&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGFja2VyfGVufDB8fDB8fHww"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Process Hollowing Demistyfied"><meta name=twitter:description content="ret2libc"><meta property="twitter:domain" content="https://Cy83rTR0n.github.io/website/process-hollowing/"><meta property="twitter:url" content="https://Cy83rTR0n.github.io/website/process-hollowing/"><meta name=twitter:image content="https://images.unsplash.com/photo-1544890225-2f3faec4cd60?auto=format&amp;fit=crop&amp;q=60&amp;w=500&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGFja2VyfGVufDB8fDB8fHww"><link rel=canonical href=https://Cy83rTR0n.github.io/website/process-hollowing/><link rel=stylesheet type=text/css href=/website/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/website/css/main.min.css><link id=dark-theme rel=stylesheet href=/website/css/dark.min.css><script src=/website/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://Cy83rTR0n.github.io/website><img src='https://images.unsplash.com/photo-1544890225-2f3faec4cd60?auto=format&amp;fit=crop&amp;q=60&amp;w=500&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGFja2VyfGVufDB8fDB8fHww' alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://Cy83rTR0n.github.io/website>Reverse Engineering Blog</a></div><div class=nav-links><div class=nav-link><a href=https://Cy83rTR0n.github.io/website/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://Cy83rTR0n.github.io/website/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://Cy83rTR0n.github.io/website/projects/><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://Cy83rTR0n.github.io/website/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/Cy83rTR0n><span data-feather=github></span></a></div><div class=nav-link><a href=https://www.reddit.com/user/Cy83rTr0n/><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://Cy83rTR0n.github.io/website/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://Cy83rTR0n.github.io/website/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://Cy83rTR0n.github.io/website/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://Cy83rTR0n.github.io/website/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/Cy83rTR0n><span data-feather=github></span></a></li><li class=nav-item><a href=https://www.reddit.com/user/Cy83rTr0n/><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Process Hollowing Demistyfied</h1><small role=doc-subtitle>ret2libc</small><p class=post-date>April 25, 2023</p><ul class=post-tags><li class=post-tag><a href=https://Cy83rTR0n.github.io/website/tags/malware>Malware</a></li></ul></div><div class=post-content><p><h1 id=about>About</h1><p>Process hollowing is a technique used by several malware authors used to run a legitimate process in suspended state and then replacing it&rsquo;s code with the contents of a new process.</p><h2 id=positive-implications>Positive implications</h2><p>Before Understanding about how it is actually used in malware development, let&rsquo;s look at how can it be used for helping software developers during SDLC.</p><p>a) It can be used for identifying vulnerabilities in software before deployment. In several cases this technique also helps us to understand the inner working of a process and thus giving understand about their functional behaviour.</p><p>b) This technique is also used by game developers as an anti-cheat measure in their games. By injecting code into the game applications they can safeguard from players being able to cheat in games.</p><p>Other than the above, process hollowing is also used in fields like forensics analysis, Software Testing and Quality Assurance, etc.</p><h2 id=-interesting-part>üòà Interesting Part</h2><p><img src=https://hackmd.io/_uploads/BJZefLtX6.png alt=process_hollowing.png></p><p>I am myself learning from a github repo, so will try to note my learnings into this as and when I reading the thing in the other tab. Eventaully I will also try to recreate the whole thing and test it out. Though I understand this technique is already very well known, but I guess it kinda starts our journey into understanding various tactics used by malwares and also will help us to understand the details regarding what goes behind the curtains of this attack technique. Anyways let&rsquo;s get it to it then. Hopefully by the end of this we will have a working sample of Process Hollowing POC.</p><h2 id=lets-code-our-way-through->Let&rsquo;s Code our way through !!</h2><pre tabindex=0><code>	LPSTARTUPINFOA target1 = new STARTUPINFOA();
	LPPROCESS_INFORMATION target2 = new     PROCESS_INFORMATION();
	CONTEXT c;
</code></pre><p>Well I spent a good amount of time in understanding what actually the above code snippet meant.</p><p>Let me jot down for you what it means point-wise</p><h3 id=i-explaination>I Explaination</h3><ol><li>LPSTARTUPINFOA is a pointer to the structure STARTUPINFOA and on the right hand side we are dynamically allocating memory for the STARTUPINFOA structure. By the way important information, STARTUPINFOA structure is used to configure how a process runs.</li><li>For PROCESS_INFORMATION line, Exactly the same things are happening except that this structure is used to gain information about the new process created.</li><li>CONTEXT is the structure which gives us access to the context of the thread and also keep a track of the various registers used.</li></ol><p>Hopefully I was able to explain the things, hence let&rsquo;s move on.</p><pre tabindex=0><code>
if (CreateProcessA(
		(LPSTR)&#34;C:\\Windows\\System32\\svchost.exe&#34;,
		NULL,
		NULL,
		NULL,
		TRUE,
		CREATE_SUSPENDED,
		NULL,
		NULL,
		target_si,
		target_pi) == 0) 
        {
		cout &lt;&lt; &#34;[!#!] Failed to create Target process. Last Error: &#34; &lt;&lt; GetLastError();
		return 1;
	}
</code></pre><p>Interesting eh üòÅ!!</p><h3 id=ii-explaination>II Explaination</h3><ol><li>We use CreateProcessA API an API used to create a new process and runs in the context of the calling process.</li><li>Two very important arguments in the above context are first one which is to be created and the CREATE_SUSPENDED flag.</li><li>For more information refer to <a href=https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa>CreateProcessA MSDN</a></li></ol><pre tabindex=0><code>	HANDLE hMaliciousCode = CreateFileA(
		(LPCSTR)&#34;C:\\Users\\Sample\\Desktop\\Dev\\SusProcess\\Debug\\SusProcess.exe&#34;,
		GENERIC_READ,
		FILE_SHARE_READ,
		NULL,
		OPEN_EXISTING,
		NULL,
		NULL
	);
	cout &lt;&lt; &#34;[+] Process PID-&gt; 0x&#34; &lt;&lt; target_pi-&gt;dwProcessId &lt;&lt; endl;

	if (hMaliciousCode == INVALID_HANDLE_VALUE) {
		cout &lt;&lt; &#34;[!] Failed to open Malicious file: &#34; &lt;&lt; GetLastError()&lt;&lt;endl;
		TerminateProcess(target_pi-&gt;hProcess, 0);
	}
	cout &lt;&lt; &#34;[#+#] Malicious file opened.&#34; &lt;&lt; endl;
</code></pre><p>Well it might look little daunting, but it is kinda easy to get to it.</p><p>Breaking it down üòâ</p><h3 id=iii-explaination>III Explaination</h3><ol><li>Like last snippet we are opening a handle to our malicious proces.</li><li>We then for debug purposes print the process opened before&rsquo;s PID.</li><li>We check whether our üíÄ suspicious process is succesfully created if not then we terminate it.</li><li>Finally we print a message saying that out malicious file is opened.</li></ol><p>So the story till now stands like this,</p><ul><li>We have two processes opened with a handle poiting to the latter one.</li><li>And most importantly the first one is opened in a suspended state</li></ul><pre tabindex=0><code>	DWORD maliciousFileSize = GetFileSize(hMaliciousCode, 0);
	cout &lt;&lt; &#34;[+] Malicious file size: &#34; &lt;&lt; maliciousFileSize &lt;&lt; &#34; bytes.&#34; &lt;&lt; endl;

	PVOID pMaliciousImage = VirtualAlloc(NULL,maliciousFileSize,0x3000,0x04);
    
</code></pre><p>Well looks kinda interesting, We have reference to VirtualAlloc and that is definitely something fishy ü§î.</p><h3 id=iv-explaination>IV Explaination</h3><ol><li>In the above context we have used two APIs.</li><li>GetFileSize is used to find the size of our malicious executable in bytes so that the same can be used to map a memory region for further running of process.</li><li>VirtualAlloc is the API used for allocating a region of memory in the virtual address space of our process, in this case the 1st process.</li><li>maliciousFileSize is used to tell the size used for allocating the amount of memory.</li><li>0x3000 indicates to allocation type which corresponds to &lsquo;MEM_COMMIT | MEM_RESERVE&rsquo;, which in turn means that memory of both reserved and intialized, and marked as a placeholder in the process&rsquo;s address space.</li></ol><p>Well now I have a feeling we are slowly getting there for the actuall part, let the suspense be there ‚è≥.</p></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg><script>let mybutton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#about>About</a><ul><li><a href=#positive-implications>Positive implications</a></li><li><a href=#-interesting-part>üòà Interesting Part</a></li><li><a href=#lets-code-our-way-through->Let&rsquo;s Code our way through !!</a><ul><li><a href=#i-explaination>I Explaination</a></li><li><a href=#ii-explaination>II Explaination</a></li><li><a href=#iii-explaination>III Explaination</a></li><li><a href=#iv-explaination>IV Explaination</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2023 The Marauders</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>