<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Ryuk Malware</title>
<meta name=description content="We will write something interesting here!!"><meta name=keywords content='blog,gokarna,hugo,Malware'><meta property="og:url" content="https://Cy83rTR0n.github.io/website/posts/ryuk/"><meta property="og:type" content="website"><meta property="og:title" content="Ryuk Malware"><meta property="og:description" content="We will write something interesting here!!"><meta property="og:image" content="https://images.unsplash.com/photo-1544890225-2f3faec4cd60?auto=format&amp;fit=crop&amp;q=60&amp;w=500&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGFja2VyfGVufDB8fDB8fHww"><meta property="og:image:secure_url" content="https://images.unsplash.com/photo-1544890225-2f3faec4cd60?auto=format&amp;fit=crop&amp;q=60&amp;w=500&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGFja2VyfGVufDB8fDB8fHww"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Ryuk Malware"><meta name=twitter:description content="We will write something interesting here!!"><meta property="twitter:domain" content="https://Cy83rTR0n.github.io/website/posts/ryuk/"><meta property="twitter:url" content="https://Cy83rTR0n.github.io/website/posts/ryuk/"><meta name=twitter:image content="https://images.unsplash.com/photo-1544890225-2f3faec4cd60?auto=format&amp;fit=crop&amp;q=60&amp;w=500&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGFja2VyfGVufDB8fDB8fHww"><link rel=canonical href=https://Cy83rTR0n.github.io/website/posts/ryuk/><link rel=stylesheet type=text/css href=/website/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/website/css/main.min.css><link id=dark-theme rel=stylesheet href=/website/css/dark.min.css><script src=/website/js/bundle.min.fbe2f55794ed6ded1573152a130784ee5cb022de9676b19dd37d7559ee6f6fc6.js integrity="sha256-++L1V5Ttbe0VcxUqEweE7lywIt6WdrGd0311We5vb8Y="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://Cy83rTR0n.github.io/website/><img src='https://images.unsplash.com/photo-1544890225-2f3faec4cd60?auto=format&amp;fit=crop&amp;q=60&amp;w=500&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGFja2VyfGVufDB8fDB8fHww' alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://Cy83rTR0n.github.io/website/>Reverse Engineering Blog</a></div><div class=nav-links><div class=nav-link><a href=https://Cy83rTR0n.github.io/website/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://Cy83rTR0n.github.io/website/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://Cy83rTR0n.github.io/website/projects/><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://Cy83rTR0n.github.io/website/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/Cy83rTR0n><span data-feather=github></span></a></div><div class=nav-link><a href=https://www.reddit.com/user/Cy83rTr0n/><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://Cy83rTR0n.github.io/website/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://Cy83rTR0n.github.io/website/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://Cy83rTR0n.github.io/website/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://Cy83rTR0n.github.io/website/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/Cy83rTR0n><span data-feather=github></span></a></li><li class=nav-item><a href=https://www.reddit.com/user/Cy83rTr0n/><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Ryuk Malware</h1><small role=doc-subtitle>We will write something interesting here!!</small><p class=post-date>March 6, 2021</p><ul class=post-tags><li class=post-tag><a href=https://Cy83rTR0n.github.io/website/tags/malware>Malware</a></li></ul></div><div class=post-content><p><h1 id=technical-analysis-of-ryuk-malware>Technical Analysis of Ryuk Malware</h1><hr><p>Below details are for stage 1</p><table><thead><tr><th>Name</th><th>Ryuk Malware</th></tr></thead><tbody><tr><td>1. MD5</td><td>5ac0f050f93f86e69026faea1fbb4450</td></tr><tr><td>2. SHA-1</td><td>9709774fde9ec740ad6fed8ed79903296ca9d571</td></tr><tr><td>3. SHA-256</td><td>23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2</td></tr><tr><td>4. File type</td><td>Win32 EX</td></tr></tbody></table><h2 id=overview>Overview</h2><p>It is a 2 stage malware, where the first stage when initiated suddenly vanishes from the system and drops the second stage to carry out the task of privilege escalation, persistence, and process injection. The details about how it carries out each stage are mentioned further in the report.</p><h2 id=preliminary-analysis>Preliminary Analysis</h2><h3 id=snapshot-from-virustotal>Snapshot from VirusTotal</h3><p><img src=https://hackmd.io/_uploads/SJCxMoLmp.png alt=Untitled.png></p><h3 id=snapshot-from-hybridanalysis>Snapshot from HybridAnalysis</h3><p><img src=https://hackmd.io/_uploads/H1VqQjL7a.png alt="Untitled 1.png"></p><h3 id=mitre-attck-analysis>MITRE ATT&amp;CK Analysis</h3><ul><li>Persistence</li><li>Privilege Escalation</li><li>Defense Evasion</li><li>Credential Access</li><li>Discovery</li><li>Exfiltration</li></ul><p><strong>For better Visuals and info refer to the given links</strong></p><p><a href=https://www.hybrid-analysis.com/sample/23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2/5b78ac487ca3e1394667d414>https://www.hybrid-analysis.com/sample/23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2/5b78ac487ca3e1394667d414</a></p><p><a href=https://www.virustotal.com/gui/file/23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2/>https://www.virustotal.com/gui/file/23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2/</a></p><h2 id=basic-analysis-of-stage-i>Basic Analysis of Stage I</h2><p>At the very start, we see that the ransomware tries to retrieve the Major version of the system and based on it drops the second stage either in of the specified paths.</p><p>![Untitled]<img src=https://hackmd.io/_uploads/rJ_j7i87p.png alt="Untitled 2.png"></p><h2 id=dynamic-analysis-of-stage-i>Dynamic Analysis of Stage I</h2><p>Later we see that an executable is made on the fly whose name is random 5 characters. later is appended with .exe extension.</p><p><img src=https://hackmd.io/_uploads/Sy9f4j8Xp.png alt="Untitled 3.png"></p><p>Later when it tries to create the file in the directory incase it fails the name of the file is kept as ryuV.exe, Hence a ‘V’ being replaced in place of ‘k’.</p><p><img src=https://hackmd.io/_uploads/HkLuEi8Xp.png alt="Untitled 4.png"></p><p>After creation of the file, its time to load the malicious code inside of it. For this stage 1 checks whether the current process is running in 64 bit or 32 bit operating system using IsWowProcess(). Based on the result stage 1 loads code into the newly created file.</p><p>For getting the relevant imports of dlls Ryuk uses LoadlibraryA(”Kernel32.dll”) and GetProcAddress().</p><p><img src=https://hackmd.io/_uploads/B1qYVoLXT.png alt="Untitled 5.png"></p><p>Finally once the file is ready Ryuk uses ShellExecuteW() to commit the file to the specified directory.</p><h2 id=stage-ii>Stage II</h2><table><thead><tr><th>SHA256</th><th>8b0a5fb13309623c3518473551cb1f55d38d8450129d4a3c16b476f7b2867d7d</th></tr></thead></table><h3 id=analysis>Analysis</h3><p>Well, this part is still a little mystery to me, however referring to the old analysis I came to this point once stage I has completed its job of making the second one it passes to it as a command line argument and deletes itself.</p><p><img src=https://hackmd.io/_uploads/SJwsEj8Xp.png alt="Untitled 6.png"></p><p>To gain Persistence the ransomware uses the trick to add a run key to the registry.</p><p><img src=https://hackmd.io/_uploads/SJDN8s8X6.png alt="Untitled 7.png"></p><p>the full command goes like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>C:\Windows\System32\cmd.exe /C REG ADD <span style=color:#e6db74>&#34;HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&#34;</span>/v <span style=color:#e6db74>&#34;svchos&#34;</span> /t REG_SZ /d <span style=color:#e6db74>&#34;C:\users\Public\BPWPc.exe&#34;</span> /f
</span></span></code></pre></div><p>Further we check that whether the current user has a “SeDebugPrivilege” using its LUID. Incase it is not there it adjust the privilege using AdjustTokenPrivileges(). Hence Privilege of the current process is escalated because we need special permissions to perform the next attack.</p><p><img src=https://hackmd.io/_uploads/BkmULj8mp.png alt="Untitled 8.png"></p><p>Next the ryuk looks whether the Domain name is NTA or not. Based on that it set the values of the array in which different process’s details are collected.</p><p><img src=https://hackmd.io/_uploads/rJm88oU7a.png alt="Untitled 9.png"></p><p>In the following screenshots we see that ryuk uses process injection technique. It does this by virtually allocating room for the code and then writing to it.</p><p><img src=https://hackmd.io/_uploads/B1XULi8X6.png alt="Untitled 10.png"></p><p><img src=https://hackmd.io/_uploads/r1MIUoIQp.png alt="Untitled 11.png"></p><h3 id=encryption-process>Encryption Process</h3><p>For encryption purposes the malware uses</p><ul><li>CryptEncrypt</li><li>CryptGenKey</li><li>CryptDecrypt</li><li>CryptAquireContextW</li><li>CryptDestroyKey</li><li>CryptDeriveKey</li><li>CryptImportKey</li></ul><p>They are all a part of ADVapi32.dll</p><p>Each encryption thread starts by generating a random 256 AES encryption.</p><p><img src=https://hackmd.io/_uploads/rkXI8sUQp.png alt="Untitled 12.png"></p><p><img src=https://hackmd.io/_uploads/ByQIIjImT.png alt="Untitled 13.png"></p><p>After every file is encrypted we see that “HERMES” is being padded to each and every file</p><p><img src=https://hackmd.io/_uploads/ByQU8oUm6.png alt="Untitled 14.png"></p><p>it checks if a file is going to get encrypted twice.</p><p><img src=https://hackmd.io/_uploads/rylm8UoIQa.png alt="Untitled 15.png"></p><p>The important apis used in malware are as follows :</p><ul><li>CryptEncrypt</li><li>CryptGenKey</li><li>CryptDecrypt</li><li>CryptAquireContextW</li><li>CryptDestroyKey</li><li>CryptDeriveKey</li><li>CryptImportKey</li><li>VirtualFree</li><li>WriteProcessMemory</li><li>VirtualAllocEx</li><li>LookupPrivilegeValue</li><li>GetProcAddress</li><li>AdjustTokenPrivilege</li><li>ShellExecuteW</li><li>FreeLibrary</li><li>CreateRemoteThread</li></ul></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let mybutton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?mybutton.style.display="block":mybutton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#technical-analysis-of-ryuk-malware>Technical Analysis of Ryuk Malware</a><ul><li><a href=#overview>Overview</a></li><li><a href=#preliminary-analysis>Preliminary Analysis</a><ul><li><a href=#snapshot-from-virustotal>Snapshot from VirusTotal</a></li><li><a href=#snapshot-from-hybridanalysis>Snapshot from HybridAnalysis</a></li><li><a href=#mitre-attck-analysis>MITRE ATT&amp;CK Analysis</a></li></ul></li><li><a href=#basic-analysis-of-stage-i>Basic Analysis of Stage I</a></li><li><a href=#dynamic-analysis-of-stage-i>Dynamic Analysis of Stage I</a></li><li><a href=#stage-ii>Stage II</a><ul><li><a href=#analysis>Analysis</a></li><li><a href=#encryption-process>Encryption Process</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 The Marauders</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>